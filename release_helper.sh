#!/bin/bash

# Configuration
APP_NAME="HolyReminder"
BUILD_DIR=".build/release"
APP_BUNDLE="${APP_NAME}.app"
OUTPUT_DIR="build/Export"

echo "ðŸš€ Starting Release Build for ${APP_NAME}..."

# 1. Clean and Build
echo "ðŸ§¹ Cleaning..."
rm -rf ".build"
rm -rf "build"

echo "ðŸ”¨ Building with Swift PM..."
swift build -c release --arch arm64 --arch x86_64

if [ $? -ne 0 ]; then
    echo "âŒ Build failed."
    exit 1
fi

# 2. Create App Bundle Structure
echo "ðŸ“¦ Creating App Bundle..."
mkdir -p "${OUTPUT_DIR}"
mkdir -p "${OUTPUT_DIR}/${APP_BUNDLE}/Contents/MacOS"
mkdir -p "${OUTPUT_DIR}/${APP_BUNDLE}/Contents/Resources"

# 3. Copy Binary
echo "ï¿½ Copying Binary..."
# Check for universal binary or specific arch. `swift build --arch ...` creates universal in apple-universal if multiple?
# Or just copy from the release dir.
# Since we used --arch twice, it might be in apple-universal/release/HolyReminder
if [ -f ".build/apple/Products/Release/HolyReminder" ]; then
    cp ".build/apple/Products/Release/HolyReminder" "${OUTPUT_DIR}/${APP_BUNDLE}/Contents/MacOS/"
elif [ -f ".build/release/HolyReminder" ]; then
    cp ".build/release/HolyReminder" "${OUTPUT_DIR}/${APP_BUNDLE}/Contents/MacOS/"
else
    # Fallback to finding it
    BINARY=$(find .build -name HolyReminder -type f | grep "release" | head -n 1)
    if [ -z "$BINARY" ]; then
        echo "âŒ Could not find compiled binary."
        exit 1
    fi
    cp "$BINARY" "${OUTPUT_DIR}/${APP_BUNDLE}/Contents/MacOS/"
fi

# 4. Copy Info.plist
echo "ðŸ“ Copying Info.plist..."
if [ -f "Info.plist" ]; then
    cp "Info.plist" "${OUTPUT_DIR}/${APP_BUNDLE}/Contents/Info.plist"
else
    echo "âŒ Info.plist not found!"
    exit 1
fi

# 5. Copy Resources
echo "ðŸŽ¨ Copying Resources..."
# Copy AppIcon
if [ -f "Sources/HolyReminder/Resources/AppIcon.icns" ]; then
    cp "Sources/HolyReminder/Resources/AppIcon.icns" "${OUTPUT_DIR}/${APP_BUNDLE}/Contents/Resources/"
fi

# Copy verses.json
if [ -f "Sources/HolyReminder/Resources/verses.json" ]; then
    cp "Sources/HolyReminder/Resources/verses.json" "${OUTPUT_DIR}/${APP_BUNDLE}/Contents/Resources/"
fi

# Create Bundle.module support (HolyReminder_HolyReminder.bundle)
# SPM usually expects this bundle to exist if resources are processed.
RESOURCE_BUNDLE="${OUTPUT_DIR}/${APP_BUNDLE}/Contents/Resources/${APP_NAME}_${APP_NAME}.bundle"
mkdir -p "$RESOURCE_BUNDLE"
cp "Sources/HolyReminder/Resources/verses.json" "$RESOURCE_BUNDLE/"
# Copy Info.plist into bundle if needed (usually generated by SPM) but we can simulate it or skip if not strictly checked.
# But better to just put resources in Contents/Resources and hope the main bundle lookup finds it, 
# OR put the bundle in Contents/Resources.
# A common trick for SPM apps is to create the bundle structure inside Resources.

# 6. Sign the App
echo "ðŸ” Signing App Bundle..."
xattr -cr "${OUTPUT_DIR}/${APP_BUNDLE}"
codesign --force --deep --sign - "${OUTPUT_DIR}/${APP_BUNDLE}"

if [ $? -ne 0 ]; then
    echo "âŒ Code signing failed."
    exit 1
fi

# 7. Zip It
echo "ðŸ¤ Zipping..."
cd "${OUTPUT_DIR}"
zip -r "${APP_NAME}.zip" "${APP_BUNDLE}" > /dev/null

echo "âœ… Build complete!"
echo "ï¿½ Output: ${OUTPUT_DIR}/${APP_NAME}.zip"

# Open Finder
open .
